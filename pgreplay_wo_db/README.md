находим начало каждого мультистрочного блока из лога по сигнатуре даты/времени и добавляем вначале блока наш выделенный сепаратор "\nseparator_by_yorick\n"
далее awk скрипт режет по этому сепаратору (RS) и разбивает на поля по формату (FPAT)

```bash
$ cat example.log | sed -r 's/^([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3} .*)$/\nseparator_by_yorick\n\1/' | awk -f prog.awk >/dev/null
```

Вычисления времени из полей строки:
```
log_time = log_time - CAST(substring(message FROM E'\\d+.\\d* ms') AS interval)
```

из этой строки
```
  2018-06-05 21:02:18.373+00
```
получается
```
  2018-06-05 21:02:17.436421+00
```
от log_time отнимается duration из плана
времени окончания запроса получаем время его начала, отняв время его выполнения
```
  "2018-06-05 21:02:18.373+00" - "duration: 936.579 ms" --> "2018-06-05 21:02:17.436421+00"
  ```

```bash
$ date -u -d @$(echo "scale=6; $(($(date -u --date='2018-06-05 21:02:18.373+00' +'%s%6N') - $(date -u --date='1970-01-01 21:02:00.936579' +'%6N')))/1000000" | bc) +"%Y-%m-%d %H:%M:%S.%6N"
2018-06-05 21:02:17.436421
```
